---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: longhorn-config
  namespace: flux-system
spec:
  interval: 30m
  path: ./infrastructure/longhorn
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
  decryption:
    provider: sops
    secretRef:
      name: sops-age
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: longhorn
  namespace: flux-system
spec:
  interval: 24h
  url: https://charts.longhorn.io
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: longhorn
  namespace: flux-system
spec:
  interval: 30m
  releaseName: longhorn
  targetNamespace: longhorn
  driftDetection:
    mode: warn
    ignore:
      - paths: ["/spec/replicas"]
        target:
          kind: Deployment
      - paths: ["/spec/replicas"]
        target:
          kind: StatefulSet
      - paths: ["/spec/replicas"]
        target:
          kind: DaemonSet
  chart:
    spec:
      chart: longhorn
      version: "1.9.1"
      sourceRef:
        kind: HelmRepository
        name: longhorn
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # Longhorn storage class (not default - keep democratic-iscsi as default)
    defaultClass: false
    storageClass:
      name: "longhorn"
      isDefaultClass: false
      reclaimPolicy: "Delete"
      allowVolumeExpansion: true
      parameters:
        numberOfReplicas: "2"
        staleReplicaTimeout: "2880"  # 48 hours
        fsType: "ext4"
        
    defaultSettings:
      defaultDataPath: /var/lib/longhorn
      defaultReplicaCount: 2
      # Enforce one replica per node (hard) and per disk (hard),
      # but ignore zones (soft) for a simple 3-node cluster without AZs.
      replicaSoftAntiAffinity: "false"
      replicaDiskSoftAntiAffinity: "false"
      replicaZoneSoftAntiAffinity: "true"
      defaultDataLocality: "best-effort"
      createDefaultDiskLabeledNodes: "true"
      defaultLonghornStaticStorageClass: "longhorn"
      
    # Disable ingress - we'll use Traefik IngressRoute if needed
    ingress:
      enabled: false
    
    # Enable Prometheus metrics without ServiceMonitor (using Alloy instead)
    metrics:
      serviceMonitor:
        enabled: false
    
    # Disable service annotations - using individual pod discovery instead
    longhornManager:
      serviceAnnotations:
        prometheus.io/scrape: "false"
        prometheus.io/port: "9500"
        prometheus.io/path: "/metrics"
      resources:
        requests:
          cpu: 50m
          memory: 335Mi
        limits:
          cpu: 250m
          memory: 650Mi
      preUpgradeChecker:
        resources:
          requests:
            cpu: 12m
            memory: 50Mi
          limits:
            cpu: 13m
            memory: 50Mi
