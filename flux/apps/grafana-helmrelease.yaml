---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: grafana
  namespace: flux-system
spec:
  interval: 30m
  releaseName: grafana
  targetNamespace: o11y
  driftDetection:
    mode: warn
    ignore:
      - paths: ["/spec/replicas"]
        target:
          kind: Deployment
      - paths: ["/spec/replicas"]
        target:
          kind: StatefulSet
  chart:
    spec:
      chart: grafana
      version: "9.2.10"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # Admin credentials
    admin:
      existingSecret: "grafana-admin-secret"
      userKey: admin-user
      passwordKey: admin-password
    
    # Environment variables for Auth0 integration
    envFromSecret: grafana-auth0-secret
    
    # Disable inline datasources - use external ConfigMaps via sidecar
    datasources: {}
    
    # Enable sidecar to detect external ConfigMaps
    sidecar:
      datasources:
        enabled: true
        label: grafana_datasource
        labelValue: ""
        searchNamespace: null
        resource: configmap
        watchMethod: WATCH
    
    # Enable dashboards from configmaps
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: 'default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/default
    
    # Resource configuration for your cluster
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi
    
    # Persistence using Longhorn
    persistence:
      enabled: true
      storageClassName: "longhorn"
      size: 5Gi
    
    # Service configuration
    service:
      type: ClusterIP
      port: 80
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
        prometheus.io/path: "/metrics"
    
    # Security context
    securityContext:
      runAsNonRoot: true
      runAsUser: 472
      fsGroup: 472
    
    # Grafana configuration
    grafana.ini:
      server:
        root_url: https://grafana.i.recompiled.org
        serve_from_sub_path: false
      security:
        disable_initial_admin_creation: false
      auth:
        disable_login_form: false
        oauth_auto_login: false
      auth.generic_oauth:
        enabled: true
        name: Auth0
        allow_sign_up: true
        client_id: $__env{AUTH0_CLIENT_ID}
        client_secret: $__env{AUTH0_CLIENT_SECRET}
        scopes: openid profile email
        auth_url: https://auth.recompiled.org/authorize
        token_url: https://auth.recompiled.org/oauth/token
        api_url: https://auth.recompiled.org/userinfo
        name_attribute_path: name
        login_attribute_path: email
        role_attribute_path: contains("https://recompiled.org/roles"[*], 'Global Admin') && 'GrafanaAdmin' || contains("https://recompiled.org/roles"[*], 'grafana-admins') && 'GrafanaAdmin' || 'Viewer'
        allowed_domains: recompiled.org
      analytics:
        reporting_enabled: false
        check_for_updates: false
      log:
        mode: console
        level: info