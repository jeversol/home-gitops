apiVersion: batch/v1
kind: CronJob
metadata:
  name: renovate
  namespace: renovate
  labels:
    app.kubernetes.io/name: renovate
    app.kubernetes.io/part-of: renovate
spec:
  schedule: "3 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        metadata:
          labels:
            app.kubernetes.io/name: renovate
            app.kubernetes.io/part-of: renovate
        spec:
          serviceAccountName: renovate
          restartPolicy: Never
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            fsGroup: 0
          initContainers:
            - name: github-app-token
              image: renovate/renovate:41.140.0
              imagePullPolicy: IfNotPresent
              command: ["node", "/renovate-bin/github-app-token.js"]
              env:
                - name: RENOVATE_GITHUB_APP_ID
                  valueFrom:
                    secretKeyRef:
                      name: renovate-secret
                      key: RENOVATE_GITHUB_APP_ID
                - name: RENOVATE_GITHUB_APP_INSTALLATION_ID
                  valueFrom:
                    secretKeyRef:
                      name: renovate-secret
                      key: RENOVATE_GITHUB_APP_INSTALLATION_ID
                - name: RENOVATE_GITHUB_APP_PRIVATE_KEY
                  valueFrom:
                    secretKeyRef:
                      name: renovate-secret
                      key: RENOVATE_GITHUB_APP_PRIVATE_KEY
              volumeMounts:
                - name: renovate-auth
                  mountPath: /renovate-auth
                - name: renovate-bin
                  mountPath: /renovate-bin
              securityContext:
                runAsUser: 0
                runAsGroup: 0
                allowPrivilegeEscalation: false
                capabilities:
                  drop: ["ALL"]
                seccompProfile:
                  type: RuntimeDefault
          containers:
            - name: renovate
              image: renovate/renovate:41.140.0
              imagePullPolicy: IfNotPresent
              command: ["/bin/bash", "-lc"]
              args:
                - set -euo pipefail;
                  export RENOVATE_TOKEN="$(cat /renovate-auth/token)";
                  exec renovate
              envFrom:
                - configMapRef:
                    name: renovate-config
                - secretRef:
                    name: renovate-secret
              env:
                - name: TZ
                  value: America/Indiana/Indianapolis
                - name: RENOVATE_TMP_DIR
                  value: /tmp/renovate
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 1
                  memory: 1Gi
              securityContext:
                runAsUser: 0
                runAsGroup: 0
                allowPrivilegeEscalation: false
                seccompProfile:
                  type: RuntimeDefault
              volumeMounts:
                - name: renovate-tmp
                  mountPath: /tmp
                - name: renovate-auth
                  mountPath: /renovate-auth
                - name: renovate-bin
                  mountPath: /renovate-bin
          volumes:
            - name: renovate-tmp
              emptyDir:
                sizeLimit: 1Gi
            - name: renovate-auth
              emptyDir: {}
            - name: renovate-bin
              configMap:
                name: renovate-bin
