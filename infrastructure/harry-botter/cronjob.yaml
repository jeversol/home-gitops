apiVersion: batch/v1
kind: CronJob
metadata:
  name: harry-botter
  namespace: harry-botter
spec:
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 2
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 60
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          automountServiceAccountToken: true
          containers:
            - name: watcher
              image: ghcr.io/jeversol/cluster-multitool:latest@sha256:b12919333a7859021c3f428ceb97ac5d8a8f4d1ab9b64154c2bd4860eba63b9a
              command:
                - python
                - /script/harry-botter.py
              volumeMounts:
                - name: script
                  mountPath: /script
                - name: github-key
                  mountPath: /etc/github
                  readOnly: true
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "50m"
              env:
                - name: PYTHONUNBUFFERED
                  value: "1"
                - name: PYTHONDONTWRITEBYTECODE
                  value: "1"
              securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                allowPrivilegeEscalation: false
                capabilities:
                  drop: ["ALL"]
                seccompProfile:
                  type: RuntimeDefault
          restartPolicy: OnFailure
          serviceAccountName: harry-botter
          imagePullSecrets:
            - name: ghcr-secret
          volumes:
            - name: script
              configMap:
                name: harry-botter
                defaultMode: 484
            - name: github-key
              secret:
                secretName: github-app-key
                items:
                  - key: private-key.pem
                    path: private-key.pem
