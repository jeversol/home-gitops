---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kubernetes-resources
  namespace: o11y
spec:
  groups:
    - name: k8s.rules
      interval: 30s
      rules:
        # Container CPU usage per namespace, pod, container (with node info)
        - record: node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate
          expr: |
            sum by (cluster, namespace, pod, container) (
              irate(container_cpu_usage_seconds_total{job="cadvisor", image!="", container!=""}[5m])
            ) * on (cluster, namespace, pod) group_left(node) max by (cluster, namespace, pod, node) (
              kube_pod_info{node!=""}
            )

        - record: node_namespace_pod_container:container_cpu_usage_seconds_total:sum_rate5m
          expr: |
            sum by (cluster, namespace, pod, container) (
              rate(container_cpu_usage_seconds_total{job="cadvisor", image!="", container!=""}[5m])
            ) * on (cluster, namespace, pod) group_left(node) max by (cluster, namespace, pod, node) (
              kube_pod_info{node!=""}
            )

        # Container memory working set per namespace, pod, container
        - record: node_namespace_pod_container:container_memory_working_set_bytes
          expr: |
            container_memory_working_set_bytes{job="cadvisor", image!=""}
            * on (cluster, namespace, pod) group_left(node) max by (cluster, namespace, pod, node) (
              kube_pod_info{node!=""}
            )

        # Container memory RSS per namespace, pod, container
        - record: node_namespace_pod_container:container_memory_rss
          expr: |
            container_memory_rss{job="cadvisor", image!=""}
            * on (cluster, namespace, pod) group_left(node) max by (cluster, namespace, pod, node) (
              kube_pod_info{node!=""}
            )

        # Container memory cache per namespace, pod, container
        - record: node_namespace_pod_container:container_memory_cache
          expr: |
            container_memory_cache{job="cadvisor", image!=""}
            * on (cluster, namespace, pod) group_left(node) max by (cluster, namespace, pod, node) (
              kube_pod_info{node!=""}
            )

        # Container memory swap per namespace, pod, container
        - record: node_namespace_pod_container:container_memory_swap
          expr: |
            container_memory_swap{job="cadvisor", image!=""}
            * on (cluster, namespace, pod) group_left(node) max by (cluster, namespace, pod, node) (
              kube_pod_info{node!=""}
            )

        # Pod CPU usage (sum across all containers)
        - record: namespace_pod:kube_pod_container_resource_requests:sum
          expr: |
            sum by (cluster, namespace, pod) (
              sum by (cluster, namespace, pod, container) (
                kube_pod_container_resource_requests{resource="cpu"}
              ) * on (cluster, namespace, pod, container) group_left() max by (cluster, namespace, pod, container) (
                kube_pod_container_info
              )
            )

        # Pod memory usage (sum across all containers)
        - record: namespace_pod:kube_pod_container_resource_requests_memory:sum
          expr: |
            sum by (cluster, namespace, pod) (
              sum by (cluster, namespace, pod, container) (
                kube_pod_container_resource_requests{resource="memory"}
              ) * on (cluster, namespace, pod, container) group_left() max by (cluster, namespace, pod, container) (
                kube_pod_container_info
              )
            )

        # Namespace CPU usage
        - record: namespace:container_cpu_usage_seconds_total:sum_rate
          expr: |
            sum by (cluster, namespace) (
              sum by (cluster, namespace, pod) (
                rate(container_cpu_usage_seconds_total{job="cadvisor", image!="", container!=""}[5m])
              ) * on (cluster, namespace, pod) group_left(node) max by (cluster, namespace, pod, node) (
                kube_pod_info{node!=""}
              )
            )
