apiVersion: v1
kind: ConfigMap
metadata:
  name: mimir-custom-config
  namespace: o11y
data:
  mimir.yaml: |
    activity_tracker:
      filepath: /active-query-tracker/activity.log
    common:
      storage:
        backend: s3
        s3:
          endpoint: nas.i.recompiled.org:9000
          access_key_id: "${AWS_ACCESS_KEY_ID}"
          secret_access_key: "${AWS_SECRET_ACCESS_KEY}"
          insecure: false
    
    # Separate S3 buckets for different components
    blocks_storage:
      backend: s3
      s3:
        bucket_name: mimir-blocks
      tsdb:
        dir: /data/tsdb
      bucket_store:
        sync_dir: /data/tsdb-sync
    
    alertmanager:
      data_dir: /data
      
    alertmanager_storage:
      s3:
        bucket_name: mimir-alertmanager
    
    compactor:
      data_dir: /data
    
    ruler:
      rule_path: /data
      
    ruler_storage:
      s3:
        bucket_name: mimir-ruler
    
    # Retention configuration (1 year)
    limits:
      compactor_blocks_retention_period: 8760h  # 1 year
      max_global_series_per_user: 0  # Disabled
    
    # Query scheduler configuration
    query_scheduler:
      max_outstanding_requests_per_tenant: 10000
    
    # Memberlist configuration for ring coordination
    memberlist:
      node_name_prefix: "mimir-"
      randomize_node_name: true
      stream_timeout: 2s
      retransmit_factor: 2
      gossip_interval: 200ms
      gossip_nodes: 2
      gossip_to_dead_nodes_time: 30s
      dead_node_reclaim_time: 10m
      compression_enabled: true
      advertise_port: 7946
      bind_port: 7946
      join_members:
        - mimir-gossip-ring.o11y.svc.cluster.local:7946
    
    # Ingester configuration
    ingester:
      ring:
        store: memberlist
        replication_factor: 3
        final_sleep: 0s
        num_tokens: 512
        unregister_on_shutdown: false
        zone_awareness_enabled: true

    # Distributor configuration
    distributor:
      ring:
        store: memberlist
        
    # Store gateway configuration
    store_gateway:
      sharding_ring:
        store: memberlist
        replication_factor: 3
        zone_awareness_enabled: true
        
    # Compactor configuration  
    compactor:
      sharding_ring:
        store: memberlist
        
    # Ruler configuration
    ruler:
      ring:
        store: memberlist