apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: seaweedfs
  namespace: seaweedfs
spec:
  interval: 30m
  chart:
    spec:
      chart: seaweedfs
      version: "4.0.404" # renovate: datasource=helm depName=seaweedfs registryUrl=https://seaweedfs.github.io/seaweedfs/helm
      sourceRef:
        kind: HelmRepository
        name: seaweedfs
        namespace: flux-system
  values:
    image:
      tag: "4.04"
    
    global:
      replication: "000" # Single copy (relying on RAID)
      
    master:
      replicas: 1
      data:
        type: "persistentVolumeClaim"
        size: "10Gi"
        storageClass: "longhorn"
      logs:
        type: "emptyDir"

    filer:
      replicas: 2
      data:
        type: "emptyDir" # Metadata is in Postgres
      logs:
        type: "emptyDir"
      postgres:
        enabled: true
        # Connect to the CNPG cluster
        hostname: seaweedfs-metadata-rw.seaweedfs.svc
        database: seaweedfs
        user: app
        passwordSecretName: seaweedfs-postgres-credentials
        passwordSecretKey: password

    volume:
      replicas: 1
      dataDirs:
        - name: data1
          type: "persistentVolumeClaim"
          size: "3Ti"
          storageClass: "democratic-iscsi"
          maxVolumes: 1000
      logs:
        type: "emptyDir"
      
    s3:
      enabled: true
      enableAuth: true
      replicas: 1
      logs:
        type: "emptyDir"
      extraVolumes: |
        - name: s3-credential
          secret:
            secretName: seaweedfs-s3-credential
      extraVolumeMounts: |
        - name: s3-credential
          mountPath: /etc/seaweedfs/credential.toml
          subPath: credential.toml
          readOnly: true
      ingress:
        enabled: true
        className: traefik
        annotations:
          external-dns.alpha.kubernetes.io/expose: "true"
          external-dns.alpha.kubernetes.io/target: traefik.i.recompiled.org
          cert-manager.io/cluster-issuer: letsencrypt-production
        hosts:
          - host: s3.i.recompiled.org
            paths:
              - path: /
                pathType: Prefix
        tls:
          - secretName: s3-tls
            hosts:
              - s3.i.recompiled.org

    # Disable internal database options
    mysql:
      enabled: false
    redis:
      enabled: false
    postgresql:
      enabled: false
